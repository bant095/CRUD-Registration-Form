<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"
    />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <title>CRUD Registration Form | TIIDELab</title>
  </head>
  <body class="p-5">
    <header class="px-5 py-4 bg-blue-500 max-w-lg mx-auto">
      <h1 class="text-4xl text-white text-center font-medium">
        CRUD Registration Form
      </h1>
    </header>

    <main class="p-5 mt-5 max-w-lg mx-auto bg-blue-300 shadow-lg">
      <form class="flex flex-col gap-2" id="user-details-form">
        <input
          type="text"
          placeholder="Username"
          class="p-2 rounded-lg border border-slate-100 outline-none"
          id="username"
          required
        />
        <input
          type="text"
          placeholder="Full Name"
          class="p-2 rounded-lg border border-slate-100 outline-none"
          id="full-name"
          required
        />
        <input
          type="password"
          placeholder="Password"
          class="p-2 rounded-lg border border-slate-100 outline-none"
          id="password"
          required
        />
        <input
          type="email"
          placeholder="Email Address"
          class="p-2 rounded-lg border border-slate-100 outline-none"
          id="email"
          required
        />
        <input
          type="text"
          placeholder="Address"
          class="p-2 rounded-lg border border-slate-100 outline-none"
          id="address"
          required
        />
        <input
          type="text"
          placeholder="Zip Code"
          class="p-2 rounded-lg border border-slate-100 outline-none"
          id="zip-code"
          required
        />
        <input
          type="tel"
          placeholder="Phone Number"
          class="p-2 rounded-lg border border-slate-100 outline-none"
          id="phone-number"
          required
        />
        <select
          id="gender"
          class="p-2 rounded-lg border border-slate-100 outline-none"
          required
        >
          <option value="male">Gender</option>
          <option value="male">Male</option>
          <option value="female">Female</option>
          <option value="other">Other</option>
        </select>
        <button
          class="bg-blue-700 rounded-lg px-4 py-2 text-sm text-white mt-3"
          onclick="saveUserDetails()"
          type="button"
          id="add_Users_btn"
        >
          Submit
        </button>
        <button
          class="bg-blue-700 rounded-lg px-4 py-2 text-sm text-white mt-3"
          onclick="updateUserDetails()"
          type="button"
          id="Update_Users_btn"
        >
          Update
        </button>
      </form>
      <span class="hidden" id="form-message"></span>

      <!-- Section for displaying user inputs -->
      <section class="mt-5" id="user-details-container"></section>
    </main>

    <!-- =========================== -->
    <!-- JAVASCRIPT -->
    <script>
      // Utility function to generate a unique ID

      // Utility function to generate a unique ID
      function uuid() {
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(
          /[xy]/g,
          function (c) {
            var r = (Math.random() * 16) | 0,
              v = c == 'x' ? r : (r & 0x3) | 0x8;
            return v.toString(16);
          }
        );
      }

      //////////////////////////
      // Create - Save User Details Function
      const DB_NAME = 'user_db';

      const saveUserDetails = () => {
        // Get user details from form inputs
        const username = document.querySelector('#username');
        const fullName = document.querySelector('#full-name');
        const password = document.querySelector('#password');
        const email = document.querySelector('#email');
        const address = document.querySelector('#address');
        const zipCode = document.querySelector('#zip-code');
        const phoneNumber = document.querySelector('#phone-number');
        const gender = document.querySelector('#gender');

        // Creating an object for the user
        const userDetails = {
          id: uuid(),
          title: username.value,
          title: fullName.value,
          title: password.value,
          title: email.value,
          title: address.value,
          title: zipCode.value,
          title: phoneNumber.value,
          title: gender.value,
          created_at: Date.now(),
        };

        // Retrieving the user details from local storage or initializing an empty array
        const user_db = JSON.parse(localStorage.getItem(DB_NAME)) || [];

        // Adding the new user details to the array
        const new_user_db = [...user_db, userDetails];

        // Storing the updated user details array back in local storage
        localStorage.setItem(DB_NAME, JSON.stringify(new_user_db));

        // Fetching and displaying the updated user details
        fetchUserDetails();

        // Clear the form fields after submission
        document.querySelector('#username').value = '';
        document.querySelector('#full-name').value = '';
        document.querySelector('#password').value = '';
        document.querySelector('#email').value = '';
        document.querySelector('#address').value = '';
        document.querySelector('#zip-code').value = '';
        document.querySelector('#phone-number').value = '';
        document.querySelector('#gender').value = '';
      };

      ////////////////////////
      // Read - Fetch User Details Function
      const fetchUserDetails = () => {
        // Using container element where the user details will be displayed
        const userDetailsContainer = document.querySelector(
          '#user-details-container'
        );
        // Getting user details from local storage
        const user_db = JSON.parse(localStorage.getItem(DB_NAME)) || [];
        const noUser = user_db.length === 0;
        // Check if there are no user details available
        if (noUser) {
          userDetailsContainer.innerHTML = `<p class="text-center text-slate-500">No user details found.</p>`;
          return;
        }

        // Display user details
        const users = user_db
          .sort((a, b) =>
            a.created_at < b.created_at
              ? 1
              : a.created_at > b.created_at
              ? -1
              : 0
          )
          .map((user) => {
            return `<div class="border rounded-lg p-3 my-2">
            <p><strong>Username:</strong> ${user.username}</p>
            <p><strong>Full Name:</strong> ${user.fullName}</p>
            <p><strong>Email:</strong> ${user.email}</p>
            <p><strong>Address:</strong> ${user.address}</p>
            <p><strong>Zip Code:</strong> ${user.zipCode}</p>
            <p><strong>Phone Number:</strong> ${user.phoneNumber}</p>
            <p><strong>Gender:</strong> ${user.gender}</p>
            <button onclick="editUser('${user.id}')" class="bg-blue-500 text-white px-3 py-1 rounded-md mt-2">Edit</button>
            <button onclick="deleteUser('${user.id}')" class="bg-red-500 text-white px-3 py-1 rounded-md mt-2">Delete</button>
          </div>`;
          });
        userDetailsContainer.innerHTML = users.join('');
      };

      // ///////////////////////////////////
      // Update/Edit Function to Populate Form with User Details for Editing
      const editUser = (id) => {
        const user_db = JSON.parse(localStorage.getItem(DB_NAME)) || [];
        const userToEdit = user_db.find((user) => user.id === id);

        if (!user_to_update) {
          return;
        }
        // Populating the form with the user details for editing
        document.querySelector('#username').value = userToEdit.username;
        document.querySelector('#full-name').value = userToEdit.fullName;
        document.querySelector('#password').value = userToEdit.password;
        document.querySelector('#email').value = userToEdit.email;
        document.querySelector('#address').value = userToEdit.address;
        document.querySelector('#zip-code').value = userToEdit.zipCode;
        document.querySelector('#phone-number').value = userToEdit.phoneNumber;
        document.querySelector('#gender').value = userToEdit.gender;

        //To hide and update btn
        const updateUserBtn = document.querySelector('#update_User_btn');
        updateUserBtn.classList.remove('hidden');
        updateUserBtn.setAttribute('user_id_to_update', id);
      };

      // Update/Edit - Function to Save Updated User Details
      const updateUser = () => {
        // Get the user details from the form inputs
        const id = document.querySelector('#username').value; // Assuming username is used as the unique identifier
        const username = document.querySelector('#username').value;
        const fullName = document.querySelector('#full-name').value;
        const password = document.querySelector('#password').value;
        const email = document.querySelector('#email').value;
        const address = document.querySelector('#address').value;
        const zipCode = document.querySelector('#zip-code').value;
        const phoneNumber = document.querySelector('#phone-number').value;
        const gender = document.querySelector('#gender').value;

        //error Message
        formMessageSpan.innerHTML = `Please provide your Detail`;
        formMessageSpan.classList.remove('hidden');
        formMessageSpan.classList.add('text-xs', 'text-red-500');
        // Retrieve the user details from local storage or initialize an empty array
        const updateUserBtn = document.querySelector('#update_to_btn');
        const user_id_to_update =
          updateUserBtn.getAttribute('user_id_to_update');
        const user_db = JSON.parse(localStorage.getItem(DB_NAME)) || [];
        // Update the specific user's details in the array
        const updated_user_db = (user_db = user_db.map((user) => {
          if (user.id === user_id_to_update) {
            return {
              ...user,
              title: username.value,
              title: fullName.value,
              title: password.value,
              title: email.value,
              title: address.value,
              title: zipCode.value,
              title: phoneNumber.value,
              title: gender.value,
            };
          } else {
            return user;
          }
        }));

        // Saving the updated user details in local storage
        localStorage.setItem(DB_NAME, JSON.stringify(updated_user_db));

        // Fetch and display the updated user details
        fetchUserDetails();

        // Clear the form fields after updating
        username.value = '';
        fullName.value = '';
        password.value = '';
        email.value = '';
        address.value = '';
        zipCode.value = '';
        phoneNumber.value = '';
        gender.value = '';

        updateUserBtn.classList.add('hidden');
        const addUserBtn = document.querySelector('#add_user_btn');
        addUserBtn.classList.remove('hidden');
      };

      ////////////////////////////
      // Delete - Function to Delete a User

      const deleteUser = (id) => {
        Swal.fire({
          title: 'Delete Form',
          text: 'Are you sure you want to delete this user?',
          icon: 'warning',
          confirmButtonText: 'Yes!',
          showCancelButton: true,
        }).then((res) => {
          console.log(res.confirmDelete);
          //to confirm the cancel btn

          if (res.confirmDelete) {
            const user_db = JSON.parse(localStorage.getItem(DB_NAME)) || [];

            // Filter out the user to be deleted
            const new_user_db = user_db.filter((user) => user.id !== id);

            // Save the updated user details in local storage
            localStorage.setItem(DB_NAME, JSON.stringify(new_user_db));

            // Fetch and display the updated user details
            fetchUserDetails();
          } else {
            return;
          }
        });
      };

      // Call the fetchUserDetails
      fetchUserDetails();
    </script>
  </body>
</html>
